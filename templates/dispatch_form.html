<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dispatch Optimizer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; }
    input, button, select { padding: 5px; margin-top: 5px; }
    .route-block { border: 1px solid #aaa; padding: 16px; margin-bottom: 24px; background: #f9f9f9; border-radius: 7px; }
    .route-block h3 { margin: 0 0 10px 0; }
    .load-row { margin-bottom: 10px; display: flex; align-items: center; }
    .load-row input { margin-right: 0; border: 1px solid #ccc; box-sizing: border-box; }
    .load-header { display: flex; font-weight: bold; margin-bottom: 3px; }
    .load-header span,
    .load-row input { 
      min-width: 130px;
      max-width: 130px;
      width: 130px;
      margin-right: 0;
      text-align: left;
    }
    .load-header span:last-child { min-width: 36px; max-width: 36px; width: 36px; }
    .load-row button { margin-left: 5px; min-width: 32px; }
    #spinner {
      display: none;
      margin: 30px auto;
      text-align: center;
    }
    #spinner svg {
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #addRouteBtn { display: none; margin-bottom: 10px; }
    .remove-route-btn { float: right; color: #e53e3e; display: none; }
  </style>
</head>
<body>
  <h2>Dispatch Optimizer</h2>
  <form id="dispatchForm">
    <!-- Route type selector -->
    <label for="routeMode">Route Type:</label>
    <select id="routeMode" name="routeMode">
      <option value="best">Best Route (AI Optimized)</option>
      <option value="direct" selected>Direct Route (Loads in Order, Multi-Route)</option>
    </select>

    <div id="routesContainer">
      <!-- Route blocks go here -->
    </div>
    <button type="button" id="addRouteBtn" onclick="addRouteBlock()">➕ Add Route</button><br><br>
    <button type="submit">Submit</button>
  </form>

  <div id="spinner">
    <svg width="50" height="50" viewBox="0 0 50 50">
      <circle
        cx="25" cy="25" r="20"
        stroke="#319795" stroke-width="5"
        fill="none"
        stroke-linecap="round"
        stroke-dasharray="90"
        stroke-dashoffset="60">
        <animateTransform
          attributeName="transform"
          type="rotate"
          from="0 25 25"
          to="360 25 25"
          dur="1s"
          repeatCount="indefinite"/>
      </circle>
    </svg>
    <div style="color:#319795;">Calculating optimal routes...</div>
  </div>
  <div id="output" style="margin-top:30px;"></div>

  <script>
    let routeCount = 0;
    let currentRouteMode = "direct"; // Default to direct

    function addRouteBlock() {
      routeCount += 1;
      const routesContainer = document.getElementById('routesContainer');
      const routeDiv = document.createElement('div');
      routeDiv.className = "route-block";
      routeDiv.dataset.routeIndex = routeCount;

      routeDiv.innerHTML = `
        <h3>Route ${routeCount} <button type="button" class="remove-route-btn" onclick="removeRouteBlock(this)">Remove Route</button></h3>
        <label>Start Location:</label>
        <input type="text" name="start" placeholder="Starting Point" required />

        <label>End Location:</label>
        <input type="text" name="end" placeholder="Ending Point" required />

        <div class="load-header">
          <span>Pickup</span>
          <span>Dropoff</span>
          <span># of Loads</span>
          <span>Rate ($/MT)</span>
          <span>Weight (MT)</span>
          <span></span>
        </div>
        <div class="loadsContainer">
          <div class="load-row">
            <input type="text" name="pickup" placeholder="Pickup City" required />
            <input type="text" name="dropoff" placeholder="Dropoff City" required />
            <input type="number" name="count" placeholder="# of Loads" value="1" min="1" required />
            <input type="number" name="rate" placeholder="Rate" value="0" min="0" step="0.01" required />
            <input type="number" name="weight" placeholder="Weight" min="0" step="0.01" value="43" required />
            <button type="button" onclick="removeLoadRow(this)">❌</button>
          </div>
        </div>
        <button type="button" onclick="addLoadRow(this)">➕ Add Load</button>
      `;
      routesContainer.appendChild(routeDiv);
      updateRouteUI();
    }

    function removeRouteBlock(btn) {
      btn.closest('.route-block').remove();
      // Update numbering and UI after removal
      updateRouteNumbers();
      updateRouteUI();
    }

    function addLoadRow(routeBtn) {
      const loadsContainer = routeBtn.closest('.route-block').querySelector('.loadsContainer');
      const row = document.createElement('div');
      row.className = "load-row";
      row.innerHTML = `
        <input type="text" name="pickup" placeholder="Pickup City" required />
        <input type="text" name="dropoff" placeholder="Dropoff City" required />
        <input type="number" name="count" placeholder="# of Loads" value="1" min="1" required />
        <input type="number" name="rate" placeholder="Rate" value="0" min="0" step="0.01" required />
        <input type="number" name="weight" placeholder="Weight" min="0" step="0.01" value="43" required />
        <button type="button" onclick="removeLoadRow(this)">❌</button>
      `;
      loadsContainer.appendChild(row);
    }

    function removeLoadRow(btn) {
      btn.parentElement.remove();
    }

    function updateRouteNumbers() {
      const blocks = document.querySelectorAll('.route-block');
      blocks.forEach((block, i) => {
        const h3 = block.querySelector('h3');
        h3.innerHTML = `Route ${i + 1} <button type="button" class="remove-route-btn" onclick="removeRouteBlock(this)">Remove Route</button>`;
        block.dataset.routeIndex = i + 1;
      });
      routeCount = blocks.length;
    }

    // Handle mode switch UI logic
    function updateRouteUI() {
      const addRouteBtn = document.getElementById("addRouteBtn");
      const removeBtns = document.querySelectorAll('.remove-route-btn');
      const routesContainer = document.getElementById("routesContainer");
      if (currentRouteMode === "direct") {
        addRouteBtn.style.display = "";
        // Show remove only if >1 route
        removeBtns.forEach(btn => btn.style.display = (routeCount > 1 ? "" : "none"));
      } else {
        addRouteBtn.style.display = "none";
        removeBtns.forEach(btn => btn.style.display = "none");
        // Only keep one route
        while (routesContainer.children.length > 1) {
          routesContainer.removeChild(routesContainer.lastChild);
        }
        routeCount = 1;
        updateRouteNumbers();
      }
    }

    // Set up everything on page load
    window.onload = function() {
      addRouteBlock(); // Always start with one
      document.getElementById("routeMode").value = "direct";
      updateRouteUI();
      document.getElementById('routeMode').addEventListener('change', function() {
        currentRouteMode = this.value;
        updateRouteUI();
      });
    };

    document.getElementById("dispatchForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      document.getElementById("output").innerHTML = "";
      document.getElementById("spinner").style.display = "block";

      // Collect all route blocks
      const routeBlocks = document.querySelectorAll('.route-block');
      let dataToSend = [];

      for (const routeDiv of routeBlocks) {
        const start = routeDiv.querySelector("input[name='start']").value.trim();
        const end = routeDiv.querySelector("input[name='end']").value.trim();
        const pickups = routeDiv.querySelectorAll("input[name='pickup']");
        const dropoffs = routeDiv.querySelectorAll("input[name='dropoff']");
        const counts = routeDiv.querySelectorAll("input[name='count']");
        const rates = routeDiv.querySelectorAll("input[name='rate']");
        const weights = routeDiv.querySelectorAll("input[name='weight']");

        const loads = [];
        for (let i = 0; i < pickups.length; i++) {
          const pickup = pickups[i].value.trim();
          const dropoff = dropoffs[i].value.trim();
          const count = parseInt(counts[i].value);
          const rate = parseFloat(rates[i].value);
          const weight = parseFloat(weights[i].value);
          for (let j = 0; j < count; j++) {
            loads.push({ pickupCity: pickup, dropoffCity: dropoff, rate, weight });
          }
        }
        dataToSend.push({ start, end, loads });
      }

      try {
        let endpoint;
        let payload;
        if (currentRouteMode === "direct") {
          endpoint = "/direct_route_multi"; // <-- You will need this backend endpoint!
          payload = { routes: dataToSend };
        } else {
          endpoint = "/dispatch";
          payload = { ...dataToSend[0] };
        }
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const html = await response.text();
        document.getElementById("output").innerHTML = html;
      } catch (err) {
        document.getElementById("output").innerHTML = "<div style='color:red;'>Error. Please try again.</div>";
      } finally {
        document.getElementById("spinner").style.display = "none";
      }
    });
  </script>
</body>
</html>
