<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dispatch Optimizer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; }
    input, button, select { padding: 5px; margin-top: 5px; }
    .route-block { border: 1px solid #aaa; padding: 16px; margin-bottom: 24px; background: #f9f9f9; border-radius: 7px; }
    .route-block h3 { margin: 0 0 10px 0; position: relative; }
    .route-block h3 button { margin-left: 5px; }
    .load-row { margin-bottom: 10px; display: flex; align-items: center; }
    .load-row input { margin-right: 0; border: 1px solid #ccc; box-sizing: border-box; }
    .load-header { display: flex; font-weight: bold; margin-bottom: 3px; }
    .load-header span,
    .load-row input { min-width: 130px; max-width: 130px; width: 130px; margin-right: 0; text-align: left; }
    .load-header span:last-child { min-width: 36px; max-width: 36px; width: 36px; }
    .load-row button { margin-left: 5px; min-width: 32px; }
    #spinner { display: none; margin: 30px auto; text-align: center; }
    #spinner svg { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #addRouteBtn { display: inline-block; margin-bottom: 10px; }
    .remove-route-btn { float: right; color: #e53e3e; display: inline; }
    .sort-toggle { margin-bottom: 10px; font-size: 16px; }
    .results-table { border-collapse: collapse; width: 100%; margin: 18px 0; background: #fff; }
    .results-table th, .results-table td { border: 1px solid #bbb; padding: 6px 10px; text-align: center; }
    .results-table th { background: #f4f4f4; }
    .settings-block { margin: 18px 0; }
    .settings-block label { margin-right: 12px; display: inline-block; }
    .settings-block input { margin-right: 18px; width: 60px; }
  </style>
</head>
<body>
  <h2>Dispatch Optimizer</h2>
  <form id="dispatchForm">
    <label for="routeMode">Route Type:</label>
    <select id="routeMode" name="routeMode">
      <option value="best">Best Route (AI Optimized)</option>
      <option value="manual">Best Route (Manual)</option>
      <option value="direct" selected>Direct Route (Loads in Order, Multi-Route)</option>
    </select>
    <div class="settings-block" id="extraSettings" style="display:none;">
      <label>Loaded % Goal: <input type="number" id="loadedPctGoal" value="65" min="1" max="100" step="1" /></label>
      <label>Max Chain Length: <input type="number" id="maxChainLength" value="6" min="1" max="20" step="1" /></label>
    </div>
    <div id="routesContainer"></div>
    <button type="button" id="addRouteBtn" onclick="addRouteBlock()">‚ûï Add Route</button><br><br>
    <button type="submit">Submit</button>
  </form>

  <div id="sortToggleDiv" class="sort-toggle" style="display:none;">
    <label>Sort By:
      <select id="sortToggle">
        <option value="loaded_pct">Loaded % (High to Low)</option>
        <option value="rpm">RPM ($/mile, High to Low)</option>
      </select>
    </label>
  </div>

  <div id="spinner">
    <svg width="50" height="50" viewBox="0 0 50 50">
      <circle cx="25" cy="25" r="20" stroke="#319795" stroke-width="5" fill="none" stroke-linecap="round" stroke-dasharray="90" stroke-dashoffset="60">
        <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite"/>
      </circle>
    </svg>
    <div style="color:#319795;">Calculating optimal routes...</div>
  </div>
  <div id="output" style="margin-top:30px;"></div>

<script>
let routeCount = 0;
let currentRouteMode = "direct";
let resultsCache = [];

function addRouteBlock() {
  routeCount += 1;
  const routesContainer = document.getElementById('routesContainer');
  const routeDiv = document.createElement('div');
  routeDiv.className = "route-block";
  routeDiv.dataset.routeIndex = routeCount;
  routeDiv.innerHTML = `
    <h3>
      Route ${routeCount}
      <button type="button" class="remove-route-btn" onclick="removeRouteBlock(this)">Remove</button>
      <button type="button" onclick="saveThisRoute(this)" style="float:right;margin-left:8px;">üíæ Save</button>
      <button type="button" onclick="showLoadMenu(this)" style="float:right;">üìÇ Load</button>
    </h3>
    <div class="load-menu" style="display:none; margin: 10px 0;"></div>
    <label>Start Location:</label>
    <input type="text" name="start" placeholder="Starting Point" required />
    <label>End Location:</label>
    <input type="text" name="end" placeholder="Ending Point" required />
    <div class="load-header"></div>
    <div class="loadsContainer"></div>
    <button type="button" onclick="addLoadRow(this)">‚ûï Add Load</button>
  `;
  routesContainer.appendChild(routeDiv);
  renderLoadHeaderAndRows(routeDiv, true);
  updateRouteUI();
}

function removeRouteBlock(btn) {
  btn.closest('.route-block').remove();
  updateRouteNumbers();
  updateRouteUI();
}

function updateRouteNumbers() {
  const blocks = document.querySelectorAll('.route-block');
  blocks.forEach((block, i) => {
    const h3 = block.querySelector('h3');
    h3.querySelector("button").innerText = `Remove`;
    block.dataset.routeIndex = i + 1;
    h3.childNodes[0].nodeValue = `Route ${i + 1} `;
  });
  routeCount = blocks.length;
}

function renderLoadHeaderAndRows(routeDiv) {
  const header = routeDiv.querySelector('.load-header');
  if (!header) return;
  header.innerHTML = `
    <span>Pickup</span><span>Dropoff</span>
    ${currentRouteMode === "best" ? "<span># of Loads</span>" : ""}
    <span>Rate ($/MT)</span><span>Weight (MT)</span>
    ${currentRouteMode === "manual" ? "<span>Required?</span>" : ""}<span></span>
  `;
  const loadsContainer = routeDiv.querySelector('.loadsContainer');
  const existing = [...loadsContainer.querySelectorAll(".load-row")].map(row => ({
    pickup: row.querySelector("input[name='pickup']").value,
    dropoff: row.querySelector("input[name='dropoff']").value,
    rate: row.querySelector("input[name='rate']").value,
    weight: row.querySelector("input[name='weight']").value,
    count: row.querySelector("input[name='count']")?.value || "1",
    required: row.querySelector("input[name='required']")?.checked || false,
  }));
  loadsContainer.innerHTML = "";
  existing.forEach(v => addLoadRowWithValues(loadsContainer, v));
  if (!existing.length) addLoadRowWithValues(loadsContainer, {});
}

function addLoadRow(btn) {
  const container = btn.closest(".route-block").querySelector(".loadsContainer");
  addLoadRowWithValues(container, {});
}

function addLoadRowWithValues(container, values) {
  const row = document.createElement('div');
  row.className = "load-row";
  row.innerHTML = `
    <input type="text" name="pickup" placeholder="Pickup City" value="${values.pickup || ""}" required />
    <input type="text" name="dropoff" placeholder="Dropoff City" value="${values.dropoff || ""}" required />
    ${currentRouteMode === "best" ? `<input type="number" name="count" value="${values.count || 1}" min="1" required />` : ""}
    <input type="number" name="rate" value="${values.rate || 0}" min="0" step="0.01" required />
    <input type="number" name="weight" value="${values.weight || 43}" min="0" step="0.01" required />
    ${currentRouteMode === "manual" ? `<input type="checkbox" name="required" ${values.required ? "checked" : ""} />` : ""}
    <button type="button" onclick="removeLoadRow(this)">‚ùå</button>
  `;
  container.appendChild(row);
}

function removeLoadRow(btn) {
  btn.parentElement.remove();
}

function updateRouteUI() {
  document.getElementById("extraSettings").style.display = (currentRouteMode !== "direct") ? "block" : "none";
  document.getElementById("sortToggleDiv").style.display = (currentRouteMode === "manual") ? "block" : "none";
  const blocks = document.querySelectorAll('.route-block');
  blocks.forEach(block => renderLoadHeaderAndRows(block));
}

function saveThisRoute(btn) {
  const routeDiv = btn.closest('.route-block');
  const name = prompt("Enter a name for this trip:");
  if (!name) return;
  const start = routeDiv.querySelector("input[name='start']").value.trim();
  const end = routeDiv.querySelector("input[name='end']").value.trim();
  const loads = Array.from(routeDiv.querySelectorAll(".load-row")).map(row => ({
    pickup: row.querySelector("input[name='pickup']").value,
    dropoff: row.querySelector("input[name='dropoff']").value,
    rate: row.querySelector("input[name='rate']").value,
    weight: row.querySelector("input[name='weight']").value,
    count: row.querySelector("input[name='count']")?.value || "1",
    required: row.querySelector("input[name='required']")?.checked || false
  }));
  const saveObj = { start, end, loads };
  const allSaves = JSON.parse(localStorage.getItem("savedTrips") || "{}");
  allSaves[name] = saveObj;
  localStorage.setItem("savedTrips", JSON.stringify(allSaves));
  alert(`Trip "${name}" saved!`);
}

function showLoadMenu(btn) {
  const routeDiv = btn.closest('.route-block');
  const menuDiv = routeDiv.querySelector('.load-menu');
  const allSaves = JSON.parse(localStorage.getItem("savedTrips") || "{}");
  const names = Object.keys(allSaves);
  if (!names.length) {
    menuDiv.innerHTML = "<div style='color:#999;'>No saved trips found.</div>";
    menuDiv.style.display = "block";
    return;
  }
  menuDiv.innerHTML = `
    <label>Select a trip to load:</label>
    <ul style="list-style:none; padding:0;">
      ${names.map(n => `
        <li style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
          <button onclick="loadNamedTrip(this, '${n}')" style="flex-grow:1; text-align:left;">${n}</button>
          <button onclick="deleteSavedTrip('${n}', this)" style="color:#e53e3e;">‚ùå</button>
        </li>
      `).join("")}
    </ul>
  `;
  menuDiv.style.display = "block";
}

function loadNamedTrip(btn, name) {
  const routeDiv = btn.closest('.route-block');
  const saved = JSON.parse(localStorage.getItem("savedTrips") || "{}")[name];
  if (!saved) return;
  routeDiv.querySelector("input[name='start']").value = saved.start || "";
  routeDiv.querySelector("input[name='end']").value = saved.end || "";
  const loadsContainer = routeDiv.querySelector('.loadsContainer');
  loadsContainer.innerHTML = "";
  saved.loads.forEach(load => addLoadRowWithValues(loadsContainer, load));
  renderLoadHeaderAndRows(routeDiv);
}

function deleteSavedTrip(name, btn) {
  if (!confirm(`Delete trip "${name}"? This cannot be undone.`)) return;
  const allSaves = JSON.parse(localStorage.getItem("savedTrips") || "{}");
  delete allSaves[name];
  localStorage.setItem("savedTrips", JSON.stringify(allSaves));
  showLoadMenu(btn.closest('.route-block').querySelector("button[onclick^='showLoadMenu']"));
}

window.onload = function () {
  addRouteBlock();
  document.getElementById("routeMode").value = "direct";
  updateRouteUI();
  document.getElementById('routeMode').addEventListener('change', function () {
    currentRouteMode = this.value;
    updateRouteUI();
    document.getElementById("output").innerHTML = "";
  });
};
</script>
</body>
</html>
