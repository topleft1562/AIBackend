<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dispatch Optimizer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; }
    input, button, select { padding: 5px; margin-top: 5px; }
    .route-block { border: 1px solid #aaa; padding: 16px; margin-bottom: 24px; background: #f9f9f9; border-radius: 7px; }
    .route-block h3 { margin: 0 0 10px 0; }
    .load-row { margin-bottom: 10px; display: flex; align-items: center; }
    .load-row input { margin-right: 0; border: 1px solid #ccc; box-sizing: border-box; }
    .load-header { display: flex; font-weight: bold; margin-bottom: 3px; }
    .load-header span,
    .load-row input { 
      min-width: 130px;
      max-width: 130px;
      width: 130px;
      margin-right: 0;
      text-align: left;
    }
    .load-header span:last-child { min-width: 36px; max-width: 36px; width: 36px; }
    .load-row button { margin-left: 5px; min-width: 32px; }
    #spinner {
      display: none;
      margin: 30px auto;
      text-align: center;
    }
    #spinner svg {
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #addRouteBtn { display: inline-block; margin-bottom: 10px; }
    .remove-route-btn { float: right; color: #e53e3e; display: inline; }
  </style>
</head>
<body>
  <h2>Dispatch Optimizer</h2>
  <form id="dispatchForm">
    <!-- Route type selector -->
    <label for="routeMode">Route Type:</label>
    <select id="routeMode" name="routeMode">
      <option value="best">Best Route (AI Optimized)</option>
      <option value="manual">Best Route (Manual)</option>
      <option value="direct" selected>Direct Route (Loads in Order, Multi-Route)</option>
    </select>

    <div id="routesContainer">
      <!-- Route blocks go here -->
    </div>
    <button type="button" id="addRouteBtn" onclick="addRouteBlock()">➕ Add Route</button><br><br>
    <button type="submit">Submit</button>
  </form>

  <div id="spinner">
    <svg width="50" height="50" viewBox="0 0 50 50">
      <circle
        cx="25" cy="25" r="20"
        stroke="#319795" stroke-width="5"
        fill="none"
        stroke-linecap="round"
        stroke-dasharray="90"
        stroke-dashoffset="60">
        <animateTransform
          attributeName="transform"
          type="rotate"
          from="0 25 25"
          to="360 25 25"
          dur="1s"
          repeatCount="indefinite"/>
      </circle>
    </svg>
    <div style="color:#319795;">Calculating optimal routes...</div>
  </div>
  <div id="output" style="margin-top:30px;"></div>

  <script>
    let routeCount = 0;
    let currentRouteMode = "direct"; // Default to direct

    function addRouteBlock() {
      routeCount += 1;
      const routesContainer = document.getElementById('routesContainer');
      const routeDiv = document.createElement('div');
      routeDiv.className = "route-block";
      routeDiv.dataset.routeIndex = routeCount;

      routeDiv.innerHTML = `
        <h3>Route ${routeCount} <button type="button" class="remove-route-btn" onclick="removeRouteBlock(this)">Remove Route</button></h3>
        <label>Start Location:</label>
        <input type="text" name="start" placeholder="Starting Point" required />

        <label>End Location:</label>
        <input type="text" name="end" placeholder="Ending Point" required />

        <div class="load-header"></div>
        <div class="loadsContainer"></div>
        <button type="button" onclick="addLoadRow(this)">➕ Add Load</button>
      `;
      routesContainer.appendChild(routeDiv);
      renderLoadHeaderAndRows(routeDiv, true); // true: do not preserve required
      updateRouteUI();
    }

    function removeRouteBlock(btn) {
      btn.closest('.route-block').remove();
      updateRouteNumbers();
      updateRouteUI();
    }

    function addLoadRow(routeBtn) {
      const routeDiv = routeBtn.closest('.route-block');
      const loadsContainer = routeDiv.querySelector('.loadsContainer');
      addLoadRowWithValues(loadsContainer, {
        pickup: "",
        dropoff: "",
        rate: "0",
        weight: "43",
        required: false,
        count: "1"
      });
    }

    function addLoadRowWithValues(loadsContainer, values) {
      const mode = currentRouteMode;
      const row = document.createElement('div');
      row.className = "load-row";
      row.innerHTML = `
        <input type="text" name="pickup" placeholder="Pickup City" required value="${values.pickup || ""}" />
        <input type="text" name="dropoff" placeholder="Dropoff City" required value="${values.dropoff || ""}" />
        ${mode === "best" ? `<input type="number" name="count" placeholder="# of Loads" value="${values.count || 1}" min="1" required />` : ""}
        <input type="number" name="rate" placeholder="Rate" value="${values.rate || 0}" min="0" step="0.01" required />
        <input type="number" name="weight" placeholder="Weight" min="0" step="0.01" value="${values.weight || 43}" required />
        ${mode === "manual" ? `<input type="checkbox" name="required" style="margin-left:6px;" />` : ""}
        <button type="button" onclick="removeLoadRow(this)">❌</button>
      `;
      loadsContainer.appendChild(row);
    }

    function removeLoadRow(btn) {
      btn.parentElement.remove();
    }

    function updateRouteNumbers() {
      const blocks = document.querySelectorAll('.route-block');
      blocks.forEach((block, i) => {
        const h3 = block.querySelector('h3');
        h3.innerHTML = `Route ${i + 1} <button type="button" class="remove-route-btn" onclick="removeRouteBlock(this)">Remove Route</button>`;
        block.dataset.routeIndex = i + 1;
      });
      routeCount = blocks.length;
    }

    function renderLoadHeaderAndRows(routeDiv, clearRequired = false) {
      // Update header for current mode
      const header = routeDiv.querySelector('.load-header');
      if (!header) return;
      let headerHtml = `
        <span>Pickup</span>
        <span>Dropoff</span>
        ${currentRouteMode === "best" ? "<span># of Loads</span>" : ""}
        <span>Rate ($/MT)</span>
        <span>Weight (MT)</span>
        ${currentRouteMode === "manual" ? "<span>Required?</span>" : ""}
        <span></span>
      `;
      header.innerHTML = headerHtml;

      // Update each row in loadsContainer to match current mode (preserve values, but always reset required on mode switch)
      const loadsContainer = routeDiv.querySelector('.loadsContainer');
      const rows = Array.from(loadsContainer.querySelectorAll('.load-row'));
      const oldVals = rows.map(row => ({
        pickup: row.querySelector("input[name='pickup']").value,
        dropoff: row.querySelector("input[name='dropoff']").value,
        rate: row.querySelector("input[name='rate']").value,
        weight: row.querySelector("input[name='weight']").value,
        required: false, // always clear required on mode switch!
        count: row.querySelector("input[name='count']") ? row.querySelector("input[name='count']").value : "1"
      }));
      loadsContainer.innerHTML = "";
      oldVals.forEach(vals => addLoadRowWithValues(loadsContainer, vals));
      if (oldVals.length === 0) addLoadRowWithValues(loadsContainer, {});
    }

    // Handle mode switch UI logic
    function updateRouteUI() {
      const addRouteBtn = document.getElementById("addRouteBtn");
      const routesContainer = document.getElementById("routesContainer");
      const blocks = document.querySelectorAll('.route-block');

      // Update all headers and load rows to match mode. Always reset required!
      blocks.forEach(block => renderLoadHeaderAndRows(block, true));

      // Toggle required attribute on Start/End inputs per mode
      blocks.forEach(block => {
        const startInput = block.querySelector("input[name='start']");
        const endInput = block.querySelector("input[name='end']");
        if (currentRouteMode === "direct") {
          startInput.removeAttribute("required");
          endInput.removeAttribute("required");
        } else {
          startInput.setAttribute("required", "required");
          endInput.setAttribute("required", "required");
        }
      });

      if (currentRouteMode === "direct") {
        addRouteBtn.style.display = "inline-block";
        const removeBtns = document.querySelectorAll('.remove-route-btn');
        removeBtns.forEach(btn => btn.style.display = (routeCount > 1 ? "inline" : "none"));
      } else {
        addRouteBtn.style.display = "none";
        while (routesContainer.children.length > 1) {
          routesContainer.removeChild(routesContainer.lastChild);
        }
        routeCount = 1;
        updateRouteNumbers();
        // After updating, hide all remove buttons (in case header got re-rendered)
        const removeBtns = document.querySelectorAll('.remove-route-btn');
        removeBtns.forEach(btn => btn.style.display = "none");
      }
    }

    // Set up everything on page load
    window.onload = function() {
      addRouteBlock(); // Always start with one
      document.getElementById("routeMode").value = "direct";
      updateRouteUI();
      document.getElementById('routeMode').addEventListener('change', function() {
        currentRouteMode = this.value;
        updateRouteUI();
      });
    };

    document.getElementById("dispatchForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      document.getElementById("output").innerHTML = "";
      document.getElementById("spinner").style.display = "block";

      // Collect all route blocks
      const routeBlocks = document.querySelectorAll('.route-block');
      let dataToSend = [];

      for (const routeDiv of routeBlocks) {
        const pickups = routeDiv.querySelectorAll("input[name='pickup']");
        const dropoffs = routeDiv.querySelectorAll("input[name='dropoff']");

        // Get raw values first
        let start = routeDiv.querySelector("input[name='start']").value.trim();
        let end = routeDiv.querySelector("input[name='end']").value.trim();

        // Gather all loads as before
        const counts = routeDiv.querySelectorAll("input[name='count']");
        const rates = routeDiv.querySelectorAll("input[name='rate']");
        const weights = routeDiv.querySelectorAll("input[name='weight']");
        const requireds = routeDiv.querySelectorAll("input[name='required']");
        const isManualMode = (currentRouteMode === "manual");
        const isBestMode = (currentRouteMode === "best");
        const loads = [];
        for (let i = 0; i < pickups.length; i++) {
          const pickup = pickups[i].value.trim();
          const dropoff = dropoffs[i].value.trim();
          const count = isBestMode ? parseInt(counts[i].value) : 1;
          const rate = parseFloat(rates[i].value);
          const weight = parseFloat(weights[i].value);
          const required = isManualMode && requireds[i] ? requireds[i].checked : false;
          for (let j = 0; j < count; j++) {
            loads.push({ pickupCity: pickup, dropoffCity: dropoff, rate, weight, required });
          }
        }

        // Only for direct route mode: fill start/end if blank
        if (currentRouteMode === "direct") {
          if (!start && loads.length) {
            start = loads[0].pickupCity || "";  // First pickup
          }
          if (!end && loads.length) {
            end = loads[loads.length - 1].dropoffCity || ""; // Last dropoff
          }
        }

        dataToSend.push({ start, end, loads });
      }

      try {
        let endpoint;
        let payload;
        if (currentRouteMode === "manual") {
          endpoint = "/manual";
          payload = { ...dataToSend[0] };  // Only the first route
        } else if (currentRouteMode === "direct") {
          endpoint = "/direct_route_multi";
          payload = { routes: dataToSend };
        } else {
          endpoint = "/dispatch";
          payload = { ...dataToSend[0] };
        }
        console.log("Payload being sent:", JSON.stringify(payload, null, 2));
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const html = await response.text();
        document.getElementById("output").innerHTML = html;
      } catch (err) {
        document.getElementById("output").innerHTML = "<div style='color:red;'>Error. Please try again.</div>";
      } finally {
        document.getElementById("spinner").style.display = "none";
      }
    });
  </script>
</body>
</html>
