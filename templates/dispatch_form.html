<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dispatch Optimizer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; }
    input, button, select { padding: 5px; margin-top: 5px; }
    .route-block { border: 1px solid #aaa; padding: 16px; margin-bottom: 24px; background: #f9f9f9; border-radius: 7px; }
    .route-block h3 { margin: 0 0 10px 0; }
    .load-row { margin-bottom: 10px; display: flex; align-items: center; }
    .load-row input { margin-right: 0; border: 1px solid #ccc; box-sizing: border-box; }
    .load-header { display: flex; font-weight: bold; margin-bottom: 3px; }
    .load-header span,
    .load-row input { min-width: 130px; max-width: 130px; width: 130px; margin-right: 0; text-align: left; }
    .load-header span:last-child { min-width: 36px; max-width: 36px; width: 36px; }
    .load-row button { margin-left: 5px; min-width: 32px; }
    .driver-row { border: 1px solid #68b4fc; background: #f3fafd; padding: 12px 16px; border-radius: 7px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .driver-row input { width: 180px; }
    #spinner { display: none; margin: 30px auto; text-align: center; }
    #spinner svg { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #addRouteBtn { display: inline-block; margin-bottom: 10px; }
    #addDriverBtn { display: inline-block; margin: 12px 0 18px 0; }
    .remove-route-btn, .remove-driver-btn { color: #e53e3e; font-size: 14px; margin-left: 10px; }
    .sort-toggle { margin-bottom: 10px; font-size: 16px; }
    .results-table { border-collapse: collapse; width: 100%; margin: 18px 0; background: #fff; }
    .results-table th, .results-table td { border: 1px solid #bbb; padding: 6px 10px; text-align: center; }
    .results-table th { background: #f4f4f4; }
    .settings-block { margin: 18px 0; }
    .settings-block label { margin-right: 12px; display: inline-block; }
    .settings-block input { margin-right: 18px; width: 60px; }
  </style>
</head>
<body>
  <h2>Dispatch Optimizer</h2>

  <!-- DRIVERS SECTION -->
  <div id="driversContainer"></div>
  <button type="button" id="addDriverBtn" onclick="addDriverRow()">‚ûï Add Driver</button>

  <form id="dispatchForm">
    <label for="routeMode">Route Type:</label>
    <select id="routeMode" name="routeMode">
      <option value="best">Best Route (AI Optimized)</option>
      <option value="manual">Best Route (Manual)</option>
      <option value="direct" selected>Direct Route (Loads in Order, Multi-Route)</option>
    </select>
    <div class="settings-block" id="extraSettings" style="display:none;">
      <label>
        Loaded % Goal:
        <input type="number" id="loadedPctGoal" value="65" min="1" max="100" step="1" />
      </label>
      <label>
        Max Chain Length:
        <input type="number" id="maxChainLength" value="6" min="1" max="20" step="1" />
      </label>
    </div>
    <div id="routesContainer"></div>
    <button type="button" id="addRouteBtn" onclick="addRouteBlock()">‚ûï Add Route</button><br><br>
    <button type="submit">Submit</button>
  </form>

  <div id="sortToggleDiv" class="sort-toggle" style="display:none;">
    <label>Sort By:
      <select id="sortToggle">
        <option value="loaded_pct">Loaded % (High to Low)</option>
        <option value="rpm">RPM ($/mile, High to Low)</option>
      </select>
    </label>
  </div>

  <div id="spinner">
    <svg width="50" height="50" viewBox="0 0 50 50">
      <circle
        cx="25" cy="25" r="20"
        stroke="#319795" stroke-width="5"
        fill="none"
        stroke-linecap="round"
        stroke-dasharray="90"
        stroke-dashoffset="60">
        <animateTransform
          attributeName="transform"
          type="rotate"
          from="0 25 25"
          to="360 25 25"
          dur="1s"
          repeatCount="indefinite"/>
      </circle>
    </svg>
    <div style="color:#319795;">Calculating optimal routes...</div>
  </div>
  <div id="output" style="margin-top:30px;"></div>

<script>
const GOOGLE_API_KEY = "{{ google_api_key }}";
let googleMapsLoaded = false;
function loadGoogleMapsApi(callback) {
  if (window.google && window.google.maps) {
    callback();
    return;
  }
  if (document.getElementById('googleMapsScript')) {
    document.getElementById('googleMapsScript').addEventListener('load', callback);
    return;
  }
  const script = document.createElement('script');
  script.id = 'googleMapsScript';
  script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&callback=onGoogleMapsLoaded`;
  script.async = true;
  script.defer = true;
  window.onGoogleMapsLoaded = function () {
    googleMapsLoaded = true;
    callback();
  };
  document.head.appendChild(script);
}

let routeCount = 0;
let driverCount = 0;
let currentRouteMode = "direct";
let resultsCache = [];
let driverInfoCache = [];

function addDriverRow(values = { start: "", end: "" }) {
  driverCount += 1;
  const driversContainer = document.getElementById('driversContainer');
  const row = document.createElement('div');
  row.className = "driver-row";
  row.dataset.driverIndex = driverCount - 1;
  row.innerHTML = `
    <label>Start: <input type="text" name="driver_start" value="${values.start}" required /></label>
    <label>End: <input type="text" name="driver_end" value="${values.end}" required /></label>
    <button type="button" class="remove-driver-btn" onclick="removeDriverRow(this)">‚ùå Remove Driver</button>
  `;
  driversContainer.appendChild(row);
  updateDriverNumbers();
}

function removeDriverRow(btn) {
  btn.closest('.driver-row').remove();
  updateDriverNumbers();
}

function updateDriverNumbers() {
  const rows = document.querySelectorAll('.driver-row');
  driverCount = rows.length;
}

function getDriversArray() {
  const driverRows = document.querySelectorAll('.driver-row');
  return Array.from(driverRows).map(row => {
    return {
      start: row.querySelector("input[name='driver_start']").value.trim(),
      end: row.querySelector("input[name='driver_end']").value.trim()
    };
  });
}

// --- ROUTE HANDLING ---

function addRouteBlock() {
  routeCount += 1;
  const routesContainer = document.getElementById('routesContainer');
  const routeDiv = document.createElement('div');
  routeDiv.className = "route-block";
  routeDiv.dataset.routeIndex = routeCount;
  routeDiv.innerHTML = `
    <h3>Route ${routeCount} <button type="button" class="remove-route-btn" onclick="removeRouteBlock(this)">Remove Route</button></h3>
    <div class="load-header"></div>
    <div class="loadsContainer"></div>
    <button type="button" onclick="addLoadRow(this)">‚ûï Add Load</button>
  `;
  routesContainer.appendChild(routeDiv);
  renderLoadHeaderAndRows(routeDiv, true);
  updateRouteUI();
}

function removeRouteBlock(btn) {
  btn.closest('.route-block').remove();
  updateRouteNumbers();
  updateRouteUI();
}

function addLoadRow(routeBtn) {
  const routeDiv = routeBtn.closest('.route-block');
  const loadsContainer = routeDiv.querySelector('.loadsContainer');
  addLoadRowWithValues(loadsContainer, {
    pickup: "",
    dropoff: "",
    rate: "0",
    weight: "43",
    required: false,
    count: "1"
  });
}

function addLoadRowWithValues(loadsContainer, values) {
  const mode = currentRouteMode;
  const row = document.createElement('div');
  row.className = "load-row";
  row.innerHTML = `
    <input type="text" name="pickup" placeholder="Pickup City" required value="${values.pickup || ""}" />
    <input type="text" name="dropoff" placeholder="Dropoff City" required value="${values.dropoff || ""}" />
    ${mode === "best" ? `<input type="number" name="count" placeholder="# of Loads" value="${values.count || 1}" min="1" required />` : ""}
    <input type="number" name="rate" placeholder="Rate" value="${values.rate || 0}" min="0" step="0.01" required />
    <input type="number" name="weight" placeholder="Weight" min="0" step="0.01" value="${values.weight || 43}" required />
    ${mode === "manual" ? `<input type="checkbox" name="required" style="margin-left:6px;" />` : ""}
    <button type="button" onclick="removeLoadRow(this)">‚ùå</button>
  `;
  loadsContainer.appendChild(row);
}

function removeLoadRow(btn) {
  btn.parentElement.remove();
}

function updateRouteNumbers() {
  const blocks = document.querySelectorAll('.route-block');
  blocks.forEach((block, i) => {
    const h3 = block.querySelector('h3');
    h3.innerHTML = `Route ${i + 1} <button type="button" class="remove-route-btn" onclick="removeRouteBlock(this)">Remove Route</button>`;
    block.dataset.routeIndex = i + 1;
  });
  routeCount = blocks.length;
}

function renderLoadHeaderAndRows(routeDiv, clearRequired = false) {
  const header = routeDiv.querySelector('.load-header');
  if (!header) return;
  let headerHtml = `
    <span>Pickup</span>
    <span>Dropoff</span>
    ${currentRouteMode === "best" ? "<span># of Loads</span>" : ""}
    <span>Rate ($/MT)</span>
    <span>Weight (MT)</span>
    ${currentRouteMode === "manual" ? "<span>Required?</span>" : ""}
    <span></span>
  `;
  header.innerHTML = headerHtml;
  const loadsContainer = routeDiv.querySelector('.loadsContainer');
  const rows = Array.from(loadsContainer.querySelectorAll('.load-row'));
  const oldVals = rows.map(row => ({
    pickup: row.querySelector("input[name='pickup']").value,
    dropoff: row.querySelector("input[name='dropoff']").value,
    rate: row.querySelector("input[name='rate']").value,
    weight: row.querySelector("input[name='weight']").value,
    required: false,
    count: row.querySelector("input[name='count']") ? row.querySelector("input[name='count']").value : "1"
  }));
  loadsContainer.innerHTML = "";
  oldVals.forEach(vals => addLoadRowWithValues(loadsContainer, vals));
  if (oldVals.length === 0) addLoadRowWithValues(loadsContainer, {});
}

function updateRouteUI() {
  const addRouteBtn = document.getElementById("addRouteBtn");
  const routesContainer = document.getElementById("routesContainer");
  const blocks = document.querySelectorAll('.route-block');
  blocks.forEach(block => renderLoadHeaderAndRows(block, true));
  if (currentRouteMode === "direct") {
    addRouteBtn.style.display = "inline-block";
    const removeBtns = document.querySelectorAll('.remove-route-btn');
    removeBtns.forEach(btn => btn.style.display = (routeCount > 1 ? "inline" : "none"));
  } else {
    addRouteBtn.style.display = "none";
    while (routesContainer.children.length > 1) {
      routesContainer.removeChild(routesContainer.lastChild);
    }
    routeCount = 1;
    updateRouteNumbers();
    const removeBtns = document.querySelectorAll('.remove-route-btn');
    removeBtns.forEach(btn => btn.style.display = "none");
  }
  document.getElementById("extraSettings").style.display = (currentRouteMode === "manual" || currentRouteMode === "best") ? "block" : "none";
  document.getElementById("sortToggleDiv").style.display = (currentRouteMode === "manual") ? "block" : "none";
}

// --- SUBMIT HANDLER ---

document.getElementById("dispatchForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  document.getElementById("output").innerHTML = "";
  document.getElementById("spinner").style.display = "block";
  resultsCache = [];

  // Get driver array (always at least 1)
  const drivers = getDriversArray();
  driverInfoCache = drivers;

  // Collect route blocks and loads
  const routeBlocks = document.querySelectorAll('.route-block');
  let loads = [];
  for (const routeDiv of routeBlocks) {
    const pickups = routeDiv.querySelectorAll("input[name='pickup']");
    const dropoffs = routeDiv.querySelectorAll("input[name='dropoff']");
    const counts = routeDiv.querySelectorAll("input[name='count']");
    const rates = routeDiv.querySelectorAll("input[name='rate']");
    const weights = routeDiv.querySelectorAll("input[name='weight']");
    const requireds = routeDiv.querySelectorAll("input[name='required']");
    const isManualMode = (currentRouteMode === "manual");
    const isBestMode = (currentRouteMode === "best");
    for (let i = 0; i < pickups.length; i++) {
      const pickup = pickups[i].value.trim();
      const dropoff = dropoffs[i].value.trim();
      const count = isBestMode ? parseInt(counts[i].value) : 1;
      const rate = parseFloat(rates[i].value);
      const weight = parseFloat(weights[i].value);
      const required = isManualMode && requireds[i] ? requireds[i].checked : false;
      for (let j = 0; j < count; j++) {
        loads.push({ pickupCity: pickup, dropoffCity: dropoff, rate, weight, required });
      }
    }
  }

  let loadedPctGoal = Number(document.getElementById("loadedPctGoal")?.value || 65);
  let maxChainLength = Number(document.getElementById("maxChainLength")?.value || 6);

  // Build payload for backend
  let endpoint, payload;
  if (currentRouteMode === "manual") {
    endpoint = "/manual";
    payload = {
      drivers,
      loads,
      loaded_pct_goal: loadedPctGoal,
      max_chain_length: maxChainLength
    };
  } else if (currentRouteMode === "direct") {
    endpoint = "/direct_route_multi";
    payload = {
      drivers,
      loads
    };
  } else {
    endpoint = "/dispatch";
    payload = {
      drivers,
      loads,
      loaded_pct_goal: loadedPctGoal,
      max_chain_length: maxChainLength
    };
  }

  try {
    const response = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await response.json();
    if (data.error) throw new Error(data.error);
    resultsCache = Array.isArray(data) ? data : data.routes;
    renderResultsTable(resultsCache, drivers);
  } catch (err) {
    document.getElementById("output").innerHTML = "<div style='color:red;'>Error. Please try again.<br>" + (err.message || err) + "</div>";
  } finally {
    document.getElementById("spinner").style.display = "none";
  }
});

document.getElementById("sortToggle").addEventListener("change", function () {
  if (resultsCache.length) renderResultsTable(resultsCache, driverInfoCache);
});

function getOrderedCitiesFromSteps(steps) {
  let cities = [];
  steps.forEach(s => {
    let seg = s.segment.replace(/<[^>]+>/g, '');
    let parts = seg.split('‚Üí').map(x => x.trim());
    parts.forEach(p => {
      if (!cities.length || p !== cities[cities.length-1] || p === parts[parts.length-1]) {
        cities.push(p);
      }
    });
  });
  if (cities[cities.length-1] !== steps[steps.length-1].segment.split('‚Üí').pop().trim()) {
    cities.push(steps[steps.length-1].segment.split('‚Üí').pop().trim());
  }
  return cities;
}

function plotGoogleRouteMap(steps, mapId) {
  let cities = getOrderedCitiesFromSteps(steps);
  if (cities.length < 2) return;
  loadGoogleMapsApi(() => {
    const map = new google.maps.Map(document.getElementById(mapId), {
      zoom: 6,
      center: { lat: 50, lng: -99 }
    });
    const directionsService = new google.maps.DirectionsService();
    const directionsRenderer = new google.maps.DirectionsRenderer({ map });
    const [origin, ...rest] = cities;
    const destination = rest.pop();
    const waypoints = rest.map(city => ({ location: city, stopover: true }));
    directionsService.route({
      origin: origin,
      destination: destination,
      waypoints: waypoints,
      travelMode: google.maps.TravelMode.DRIVING
    }, (result, status) => {
      if (status === "OK") {
        directionsRenderer.setDirections(result);
      } else {
        // fallback: just drop pins
        cities.forEach(city => {
          new google.maps.Geocoder().geocode({ address: city }, (res, stat) => {
            if (stat === 'OK' && res[0]) {
              new google.maps.Marker({ map, position: res[0].geometry.location, title: city });
            }
          });
        });
      }
    });
  });
}

let driverCollapseId = idx => `driverCollapse${idx}`;
let routeExpandId = (driverIdx, routeIdx) => `routeExpand${driverIdx}_${routeIdx}`;

function renderResultsTable(driversWithRoutes) {
  if (!driversWithRoutes.length) {
    document.getElementById("output").innerHTML =
      "<div style='color:#e53e3e'>No routes found with 65%+ loaded km.</div>";
    return;
  }
  let out = "";
  driversWithRoutes.forEach((driverEntry, dIdx) => {
    const driver = driverEntry.driver || {};
    const driverRoutes = driverEntry.routes || [];
    const dCollapse = `driverCollapse${dIdx}`;
    out += `
      <div style="margin-bottom:28px;">
        <h3 style="margin:6px 0;">
          üöö Driver ${dIdx + 1} <span style="font-weight:normal;font-size:15px;">(${driver.start} ‚Üí ${driver.end})</span>
          <button type="button" onclick="toggleCollapse('${dCollapse}')">Show/Hide Routes</button>
        </h3>
        <div id="${dCollapse}" style="display:none;">
          <table class="results-table">
            <tr>
              <th>City Sequence</th>
              <th>Load IDs</th>
              <th>Loaded km</th>
              <th>Empty km</th>
              <th>Loaded %</th>
              <th>Total km</th>
              <th>Revenue</th>
              <th>RPM ($/mile)</th>
              <th>Details</th>
            </tr>
            ${
              driverRoutes.length
                ? driverRoutes
                    .map((r, i) => {
                      const summary = r.summary || {};
                      const citySeq =
                        r.city_sequence ||
                        (summary.start
                          ? summary.start + " ‚Üí ... ‚Üí " + summary.end
                          : "-");
                      const loadIds =
                        (r.load_ids && r.load_ids.length)
                          ? r.load_ids.join(", ")
                          : (summary.load_ids
                              ? summary.load_ids.join(", ")
                              : "-");
                      const expandId = `routeExpand${dIdx}_${i}`;
                      return `
                        <tr>
                          <td>${citySeq}</td>
                          <td>${loadIds}</td>
                          <td>${summary.loaded_km}</td>
                          <td>${summary.empty_km}</td>
                          <td>${summary.loaded_pct}%</td>
                          <td>${summary.total_km}</td>
                          <td>${
                            summary.total_revenue !== undefined
                              ? summary.total_revenue
                              : summary.revenue
                          }</td>
                          <td>${summary.rpm}</td>
                          <td><button onclick="toggleDetails('${expandId}')">Expand</button></td>
                        </tr>
                        <tr id="${expandId}" style="display:none;background:#f6faff"><td colspan="9">${renderBreakdownTable(
                          r.step_breakdown,
                          `${dIdx}_${i}`
                        )}</td></tr>
                      `;
                    })
                    .join("")
                : `<tr><td colspan="9" style="color:#b91c1c;">No qualifying routes for this driver.</td></tr>`
            }
          </table>
        </div>
      </div>
    `;
  });
  document.getElementById("output").innerHTML = out;
}


function renderBreakdownTable(steps, routeIdx = 0) {
  if (!steps || !steps.length) return "<div>No breakdown available.</div>";
  let th = `<tr>
    <th>Step Type</th>
    <th>Segment</th>
    <th>KMs</th>
    <th>Rate</th>
    <th>Weight</th>
    <th>Revenue</th>
    <th>RPM ($/mile)</th>
  </tr>`;
  let rows = steps.map(s =>
    `<tr>
      <td>${capitalize(s.type)}</td>
      <td>${s.segment}</td>
      <td>${s.kms}</td>
      <td>${s.rate}</td>
      <td>${s.weight}</td>
      <td>${s.revenue}</td>
      <td>${s.rpm}</td>
    </tr>`
  ).join("");
  // Map container (unique per details section)
  const mapId = `routeMap${routeIdx}`;
  setTimeout(() => plotGoogleRouteMap(steps, mapId), 0);
  return `
    <table class="results-table" style="margin:8px 0">${th}${rows}</table>
    <div style="height:320px;margin:10px 0;border-radius:12px;overflow:hidden;">
      <div id="${mapId}" style="width:100%;height:100%;"></div>
    </div>
  `;
}

function capitalize(str) {
  return str ? str.charAt(0).toUpperCase() + str.slice(1) : "";
}

window.toggleCollapse = function (id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display = (el.style.display === "none" ? "" : "none");
};
window.toggleDetails = function (id) {
  const row = document.getElementById(id);
  if (!row) return;
  row.style.display = (row.style.display === "none") ? "" : "none";
};

window.onload = function () {
  addDriverRow({ start: "Brandon, MB", end: "Brandon, MB" });
  addRouteBlock();
  document.getElementById("routeMode").value = "direct";
  updateRouteUI();
  document.getElementById('routeMode').addEventListener('change', function () {
    currentRouteMode = this.value;
    updateRouteUI();
    document.getElementById("output").innerHTML = "";
  });
};
</script>
</body>
</html>
